import streamlit as st
import pandas as pd
import sqlite3
from io import BytesIO
import plotly.express as px
import re
import os
from openpyxl import load_workbook

DB_FILE = 'plavka.db'
TABLE_NAME = '–ü–ª–∞–≤–∫–∏'
EXCEL_FILE = 'plavka.xlsx'

st.set_page_config(page_title="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª –ø–ª–∞–≤–∫–∏", layout="wide")
st.title("–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª –ø–ª–∞–≤–∫–∏")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ SQLite
@st.cache_data
def load_data():
    conn = sqlite3.connect(DB_FILE)
    df = pd.read_sql(f'SELECT * FROM {TABLE_NAME}', conn)
    conn.close()
    return df

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –≤ Excel
def add_to_excel(new_row):
    try:
        # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if os.path.exists(EXCEL_FILE):
            backup_file = f"{EXCEL_FILE}.bak"
            try:
                import shutil
                shutil.copy2(EXCEL_FILE, backup_file)
            except Exception as e:
                st.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é: {str(e)}")
        
        if not os.path.exists(EXCEL_FILE):
            # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
            df = pd.DataFrame([new_row])
            try:
                df.to_excel(EXCEL_FILE, index=False, engine='openpyxl')
                st.success(f"–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª {EXCEL_FILE}")
                return True
            except PermissionError:
                st.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª Excel. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –æ—Ç–∫—Ä—ã—Ç –ª–∏ –æ–Ω –¥—Ä—É–≥–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π.")
                return False
            except Exception as e:
                st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: {str(e)}")
                return False
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
        max_attempts = 3
        attempt = 0
        while attempt < max_attempts:
            try:
                wb = load_workbook(EXCEL_FILE)
                ws = wb.active
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞—é—Ç –ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                headers = [cell.value for cell in ws[1]]
                
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
                row_values = []
                for header in headers:
                    if header in new_row:
                        row_values.append(new_row[header])
                    else:
                        row_values.append(None)
                
                ws.append(row_values)
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                wb.save(EXCEL_FILE)
                # –£–¥–∞–ª—è–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                if os.path.exists(f"{EXCEL_FILE}.bak"):
                    try:
                        os.remove(f"{EXCEL_FILE}.bak")
                    except:
                        pass
                st.success(f"–î–∞–Ω–Ω—ã–µ —Ç–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Excel —Ñ–∞–π–ª {EXCEL_FILE}")
                return True
                
            except PermissionError:
                attempt += 1
                if attempt < max_attempts:
                    st.warning(f"–§–∞–π–ª Excel –∑–∞–Ω—è—Ç. –ü–æ–ø—ã—Ç–∫–∞ {attempt} –∏–∑ {max_attempts}...")
                    import time
                    time.sleep(1)  # –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
                else:
                    st.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Excel. –§–∞–π–ª –∑–∞–Ω—è—Ç –¥—Ä—É–≥–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π.")
                    return False
            except Exception as e:
                st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å Excel: {str(e)}")
                # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                if os.path.exists(f"{EXCEL_FILE}.bak"):
                    try:
                        import shutil
                        shutil.copy2(f"{EXCEL_FILE}.bak", EXCEL_FILE)
                        st.info("–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è Excel —Ñ–∞–π–ª–∞")
                    except:
                        pass
                return False
    except Exception as e:
        st.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ Excel: {str(e)}")
        return False

def save_to_excel(df):
    # –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤ –æ–ø–æ–∫ –∫ —Å—Ç—Ä–æ–∫–µ –±–µ–∑ .0
    for col in ['–°–µ–∫—Ç–æ—Ä_A_–æ–ø–æ–∫–∏', '–°–µ–∫—Ç–æ—Ä_B_–æ–ø–æ–∫–∏', '–°–µ–∫—Ç–æ—Ä_C_–æ–ø–æ–∫–∏', '–°–µ–∫—Ç–æ—Ä_D_–æ–ø–æ–∫–∏']:
        if col in df.columns:
            df[col] = df[col].apply(lambda x: str(int(x)) if pd.notnull(x) and isinstance(x, float) and x.is_integer() else str(x) if pd.notnull(x) else '')
    output = BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False)
    output.seek(0)
    return output

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ —á—á:–º–º
TIME_PATTERN = re.compile(r'^([01]?\d|2[0-3]):[0-5]\d$')
def is_valid_time(val):
    if not val: return True
    return bool(TIME_PATTERN.match(str(val)))

def parse_plavka_number(num):
    # num: —Å—Ç—Ä–æ–∫–∞ –≤–∏–¥–∞ '5-102' –∏–ª–∏ '05-102'
    try:
        parts = str(num).split('-')
        if len(parts) == 2:
            nnn = parts[1].zfill(3)
        else:
            nnn = str(num).zfill(3)
        return nnn
    except Exception:
        return str(num).zfill(3)

def generate_id_plavka(date, num):
    nnn = parse_plavka_number(num)
    return f"{date.year}{date.month:02d}{nnn}"

def generate_uchet_number(date, num):
    nnn = parse_plavka_number(num)
    return f"{date.month:02d}-{nnn}/{str(date.year)[-2:]}"

def parse_import_message(text):
    # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É —Å–º–µ–Ω—ã –∏–∑ —à–∞–ø–∫–∏
    m = re.search(r'üìÖ –î–∞—Ç–∞: ([0-9]{2}\.[0-9]{2}\.[0-9]{4})', text)
    plavka_date = m.group(1) if m else ''
    
    # –ü–∞—Ä—Å–∏–º —Å—Ç–∞—Ä—à–µ–≥–æ —Å–º–µ–Ω—ã –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ —à–∞–ø–∫–∏
    m = re.search(r'üë®‚Äçüíº –°—Ç–∞—Ä—à–∏–π: ([^\n]+)', text)
    starshiy = m.group(1).strip() if m else ''
    
    # –ü–∞—Ä—Å–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    uchastniki = []
    participants_match = re.search(r'üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ \(\d+\):([\s\S]*?)(?=\n\nüî• –î–ï–¢–ê–õ–ò –ü–õ–ê–í–û–ö:|$)', text)
    if participants_match:
        participants_text = participants_match.group(1)
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º–µ–Ω–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞
        participants = re.findall(r'‚Ä¢ ([^\n]+)', participants_text)
        uchastniki = [p.strip() for p in participants]
    
    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –±–ª–æ–∫–∏ –ø–æ –ø–ª–∞–≤–∫–∞–º
    blocks = re.split(r'\n(?=‚úÖ \d+\. |üîÑ \d+\. )', text)
    results = []
    
    for block in blocks:
        if '–ü–ª–∞–≤–∫–∞' not in block:
            continue
            
        data = {}
        # –î–∞—Ç–∞ —Å–º–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∞–≤–∫–∏
        data['–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞'] = plavka_date
        
        # –°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã –∏ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∞–≤–∫–∏
        data['–°—Ç–∞—Ä—à–∏–π_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏'] = starshiy
        for i, field in enumerate(['–ü–µ—Ä–≤—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', '–í—Ç–æ—Ä–æ–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', '–¢—Ä–µ—Ç–∏–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', '–ß–µ—Ç–≤–µ—Ä—Ç—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏']):
            data[field] = uchastniki[i] if i < len(uchastniki) else ''
        
        # –ü–ª–∞–≤–∫–∞ (–£—á–µ—Ç–Ω—ã–π –Ω–æ–º–µ—Ä)
        m = re.search(r'–ü–ª–∞–≤–∫–∞ ([0-9]+-[0-9]+/[0-9]{2})', block)
        if m:
            data['–£—á–µ—Ç–Ω—ã–π_–Ω–æ–º–µ—Ä'] = m.group(1).strip()
        
        # –ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞
        m = re.search(r'üìã –ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞: (\d+)', block)
        if m:
            data['–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è_–∫–∞—Ä—Ç–∞'] = m.group(1).strip()
        
        # –ö–ª–∞—Å—Ç–µ—Ä
        m = re.search(r'üè∑Ô∏è –ö–ª–∞—Å—Ç–µ—Ä: ([^\n]+)', block)
        if m:
            data['–ù–æ–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä–∞'] = m.group(1).strip()
        
        # –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ç–ª–∏–≤–∫–∏
        m = re.search(r'üè≠ –û—Ç–ª–∏–≤–∫–∞: ([^\n]+)', block)
        if m:
            data['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏'] = m.group(1).strip()
        
        # –¢–∏–ø —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ (–õ–∏—Ç–Ω–∏–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
        m = re.search(r'‚öôÔ∏è –õ–∏—Ç–Ω–∏–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞: ([^\n]+)', block)
        if m:
            data['–¢–∏–ø_—ç–∫—Å–ø–µ—Ä–µ–º–µ–Ω—Ç–∞'] = m.group(1).strip()
        
        # –û–ø–æ–∫–∏
        m = re.search(r'üì¶ –û–ø–æ–∫–∏:\s*([^\n]+)', block)
        opoki = []
        if m:
            opoki = [x.strip().replace('–û–ø–æ–∫–∞ ‚Ññ', '') for x in m.group(1).split(',')]
            opoki = [str(int(o)) if o.isdigit() or (o.replace('.','',1).isdigit() and float(o).is_integer()) else o for o in opoki]
        
        # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
        m = re.search(r'üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ([0-9]+[.,]?[0-9]*)', block)
        temp = float(m.group(1).replace(',', '.').replace('¬∞C', '')) if m else None
        
        # –í—Ä–µ–º—è –∑–∞–ª–∏–≤–∫–∏
        m = re.search(r'‚è∞ –í—Ä–µ–º—è –∑–∞–ª–∏–≤–∫–∏: ([0-9]{2}:[0-9]{2})', block)
        time_val = m.group(1).strip() if m else ''
        
        # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        m = re.search(r'üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ([^\n]+)', block)
        comment = m.group(1).strip() if m else ''
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ª–∏–≤–∫–∏
        data['–ü–ª–∞–≤–∫–∞_–≤—Ä–µ–º—è_–∑–∞–ª–∏–≤–∫–∏'] = time_val
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        data['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'] = comment
        
        # –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–∫—Ç–æ—Ä–∞ (–æ–ø–æ–∫–∏ –∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã)
        for i, sector in enumerate(['A', 'B', 'C', 'D']):
            if i < len(opoki):
                data[f'–°–µ–∫—Ç–æ—Ä_{sector}_–æ–ø–æ–∫–∏'] = opoki[i]
                data[f'–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_{sector}'] = temp
            else:
                data[f'–°–µ–∫—Ç–æ—Ä_{sector}_–æ–ø–æ–∫–∏'] = ''
                data[f'–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_{sector}'] = None
        results.append(data)
    return results

# –û—Å–Ω–æ–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
menu = st.sidebar.radio("–ù–∞–≤–∏–≥–∞—Ü–∏—è", ["–¢–∞–±–ª–∏—Ü–∞", "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å", "–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel", "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "–ò–º–ø–æ—Ä—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è", "–û –ø—Ä–æ–≥—Ä–∞–º–º–µ"])

# –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∞–π–¥–±–∞—Ä–µ
if st.sidebar.button("üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"):
    st.cache_data.clear()
    st.rerun()

df = load_data()

if menu == "–¢–∞–±–ª–∏—Ü–∞":
    st.subheader("–í—Å–µ –∑–∞–ø–∏—Å–∏ –∂—É—Ä–Ω–∞–ª–∞")
    # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º
    with st.expander("–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º"):
        search_col = st.selectbox("–ü–æ–ª–µ –¥–ª—è –ø–æ–∏—Å–∫–∞", df.columns, index=0)
        search_val = st.text_input("–ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ (—Ç–æ—á–Ω–æ–µ –∏–ª–∏ —á–∞—Å—Ç—å)")
        multi_search = st.checkbox("–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –Ω–∏–∂–µ")
    # –ë–∞–∑–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    col1, col2, col3 = st.columns(3)
    with col1:
        date_filter = st.text_input("–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2024-05-01)")
    with col2:
        participant_filter = st.text_input("–§–∏–ª—å—Ç—Ä –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫—É")
    with col3:
        name_filter = st.text_input("–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é –æ—Ç–ª–∏–≤–∫–∏")
    filtered = df.copy()
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä
    if search_val:
        filtered = filtered[filtered[search_col].astype(str).str.contains(search_val, case=False, na=False)]
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –±–∞–∑–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã, –µ—Å–ª–∏ multi_search –∏–ª–∏ search_val –Ω–µ –∑–∞–¥–∞–Ω
    if (not search_val) or multi_search:
        if date_filter:
            filtered = filtered[filtered['–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞'].astype(str).str.contains(date_filter)]
        if participant_filter:
            filtered = filtered[
                filtered['–°—Ç–∞—Ä—à–∏–π_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏'].astype(str).str.contains(participant_filter) |
                filtered['–ü–µ—Ä–≤—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏'].astype(str).str.contains(participant_filter) |
                filtered['–í—Ç–æ—Ä–æ–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏'].astype(str).str.contains(participant_filter) |
                filtered['–¢—Ä–µ—Ç–∏–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏'].astype(str).str.contains(participant_filter) |
                filtered['–ß–µ—Ç–≤–µ—Ä—Ç—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏'].astype(str).str.contains(participant_filter)
            ]
        if name_filter:
            filtered = filtered[filtered['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏'].astype(str).str.contains(name_filter)]
    st.dataframe(filtered, use_container_width=True)

elif menu == "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å":
    st.subheader("–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å")
    with st.form("add_form", clear_on_submit=True):
        col1, col2 = st.columns(2)
        with col1:
            –ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞ = st.date_input("–î–∞—Ç–∞", format="DD.MM.YYYY")
            –ù–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏ = st.text_input("–ù–æ–º–µ—Ä –ø–ª–∞–≤–∫–∏")
            –ù–æ–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä–∞ = st.text_input("–ù–æ–º–µ—Ä –∫–ª–∞—Å—Ç–µ—Ä–∞")
            –ü–ª–∞–≤–∫–∞_–≤—Ä–µ–º—è_–∑–∞–ª–∏–≤–∫–∏ = st.text_input("–í—Ä–µ–º—è —Å–ª–∏–≤–∞ (—á—á:–º–º)")
            –°—Ç–∞—Ä—à–∏–π_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏ = st.selectbox("–°—Ç–∞—Ä—à–∏–π —Å–º–µ–Ω—ã", ["", "–ë–µ–ª–∫–æ–≤", "–ö–∞—Ä–∞—Å–µ–≤", "–ï—Ä–º–∞–∫–æ–≤", "–†–∞–±–∏–Ω–æ–≤–∏—á", "–í–∞–ª–∏—É–ª–∏–Ω", "–í–æ–ª–∫–æ–≤", "–°–µ–º–µ–Ω–æ–≤", "–õ–µ–≤–∏–Ω", "–ò—Å–º–∞–∏–ª–æ–≤", "–ë–µ–ª—è–µ–≤", "–ü–æ–ª–∏—Ç–æ–≤", "–ö–æ–∫—à–∏–Ω", "–¢–µ—Ä–µ–Ω—Ç—å–µ–≤", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"])
            –ü–µ—Ä–≤—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏ = st.selectbox("–£—á–∞—Å—Ç–Ω–∏–∫ 1", ["", "–ë–µ–ª–∫–æ–≤", "–ö–∞—Ä–∞—Å–µ–≤", "–ï—Ä–º–∞–∫–æ–≤", "–†–∞–±–∏–Ω–æ–≤–∏—á", "–í–∞–ª–∏—É–ª–∏–Ω", "–í–æ–ª–∫–æ–≤", "–°–µ–º–µ–Ω–æ–≤", "–õ–µ–≤–∏–Ω", "–ò—Å–º–∞–∏–ª–æ–≤", "–ë–µ–ª—è–µ–≤", "–ü–æ–ª–∏—Ç–æ–≤", "–ö–æ–∫—à–∏–Ω", "–¢–µ—Ä–µ–Ω—Ç—å–µ–≤", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"])
            –í—Ç–æ—Ä–æ–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏ = st.selectbox("–£—á–∞—Å—Ç–Ω–∏–∫ 2", ["", "–ë–µ–ª–∫–æ–≤", "–ö–∞—Ä–∞—Å–µ–≤", "–ï—Ä–º–∞–∫–æ–≤", "–†–∞–±–∏–Ω–æ–≤–∏—á", "–í–∞–ª–∏—É–ª–∏–Ω", "–í–æ–ª–∫–æ–≤", "–°–µ–º–µ–Ω–æ–≤", "–õ–µ–≤–∏–Ω", "–ò—Å–º–∞–∏–ª–æ–≤", "–ë–µ–ª—è–µ–≤", "–ü–æ–ª–∏—Ç–æ–≤", "–ö–æ–∫—à–∏–Ω", "–¢–µ—Ä–µ–Ω—Ç—å–µ–≤", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"])
            –¢—Ä–µ—Ç–∏–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏ = st.selectbox("–£—á–∞—Å—Ç–Ω–∏–∫ 3", ["", "–ë–µ–ª–∫–æ–≤", "–ö–∞—Ä–∞—Å–µ–≤", "–ï—Ä–º–∞–∫–æ–≤", "–†–∞–±–∏–Ω–æ–≤–∏—á", "–í–∞–ª–∏—É–ª–∏–Ω", "–í–æ–ª–∫–æ–≤", "–°–µ–º–µ–Ω–æ–≤", "–õ–µ–≤–∏–Ω", "–ò—Å–º–∞–∏–ª–æ–≤", "–ë–µ–ª—è–µ–≤", "–ü–æ–ª–∏—Ç–æ–≤", "–ö–æ–∫—à–∏–Ω", "–¢–µ—Ä–µ–Ω—Ç—å–µ–≤", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"])
            –ß–µ—Ç–≤–µ—Ä—Ç—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏ = st.selectbox("–£—á–∞—Å—Ç–Ω–∏–∫ 4", ["", "–ë–µ–ª–∫–æ–≤", "–ö–∞—Ä–∞—Å–µ–≤", "–ï—Ä–º–∞–∫–æ–≤", "–†–∞–±–∏–Ω–æ–≤–∏—á", "–í–∞–ª–∏—É–ª–∏–Ω", "–í–æ–ª–∫–æ–≤", "–°–µ–º–µ–Ω–æ–≤", "–õ–µ–≤–∏–Ω", "–ò—Å–º–∞–∏–ª–æ–≤", "–ë–µ–ª—è–µ–≤", "–ü–æ–ª–∏—Ç–æ–≤", "–ö–æ–∫—à–∏–Ω", "–¢–µ—Ä–µ–Ω—Ç—å–µ–≤", "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"])
            –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏ = st.selectbox("–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ç–ª–∏–≤–∫–∏", ["", "–í–æ—Ä–æ—Ç–æ–∫", "–†–∏–≥–µ–ª—å", "–†–∏–≥–µ–ª—å optima", "–ë–ª–æ–∫-–∫–∞—Ä—Ç–µ—Ä", "–ö–æ–ª–µ—Å–æ –†–ò–¢–ú", "–ù–∞–∫–ª–∞–¥–∫–∞ —Ä–µ–∑—å–±", "–ë–ª–æ–∫ —Ü–∏–ª–∏–Ω–¥—Ä–æ–≤", "–î–∏–∞–≥–æ–Ω–∞–ª—å optima", "–ö–æ–ª—å—Ü–æ"])
            –¢–∏–ø_—ç–∫—Å–ø–µ—Ä–µ–º–µ–Ω—Ç–∞ = st.selectbox("–¢–∏–ø —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞", ["", "–ë—É–º–∞–≥–∞", "–í–æ–ª–æ–∫–Ω–æ"])
            –°–µ–∫—Ç–æ—Ä_A_–æ–ø–æ–∫–∏ = st.text_input("–°–µ–∫—Ç–æ—Ä A –æ–ø–æ–∫–∏")
            –°–µ–∫—Ç–æ—Ä_B_–æ–ø–æ–∫–∏ = st.text_input("–°–µ–∫—Ç–æ—Ä B –æ–ø–æ–∫–∏")
            –°–µ–∫—Ç–æ—Ä_C_–æ–ø–æ–∫–∏ = st.text_input("–°–µ–∫—Ç–æ—Ä C –æ–ø–æ–∫–∏")
            –°–µ–∫—Ç–æ—Ä_D_–æ–ø–æ–∫–∏ = st.text_input("–°–µ–∫—Ç–æ—Ä D –æ–ø–æ–∫–∏")
        with col2:
            # –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä –¥–ª—è —Å–µ–∫—Ç–æ—Ä–æ–≤
            –ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_A = st.number_input("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞–ª–∏–≤–∫–∏ A", min_value=500, max_value=2000, step=1, format="%d")
            –ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_B = st.number_input("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞–ª–∏–≤–∫–∏ B", min_value=500, max_value=2000, step=1, format="%d")
            –ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_C = st.number_input("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞–ª–∏–≤–∫–∏ C", min_value=500, max_value=2000, step=1, format="%d")
            –ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_D = st.number_input("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞–ª–∏–≤–∫–∏ D", min_value=500, max_value=2000, step=1, format="%d")
            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π = st.text_area("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π")
        submitted = st.form_submit_button("–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å")
    if submitted:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è
        errors = []
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        if not str(–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞) or not –ù–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏:
            errors.append("–ü–æ–ª—è '–î–∞—Ç–∞' –∏ '–ù–æ–º–µ—Ä –ø–ª–∞–≤–∫–∏' –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!")
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
        if –ü–ª–∞–≤–∫–∞_–≤—Ä–µ–º—è_–∑–∞–ª–∏–≤–∫–∏ and not is_valid_time(–ü–ª–∞–≤–∫–∞_–≤—Ä–µ–º—è_–∑–∞–ª–∏–≤–∫–∏):
            errors.append(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏: {–ü–ª–∞–≤–∫–∞_–≤—Ä–µ–º—è_–∑–∞–ª–∏–≤–∫–∏}")
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–∞ –ø–ª–∞–≤–∫–∏ –Ω–∞ –¥–∞—Ç—É
        conn = sqlite3.connect(DB_FILE)
        cur = conn.cursor()
        cur.execute(f"SELECT COUNT(*) FROM {TABLE_NAME} WHERE –ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞=? AND –ù–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏=?", (str(–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞), –ù–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏))
        if cur.fetchone()[0] > 0:
            errors.append("–ó–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –ø–ª–∞–≤–∫–∏ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!")
        conn.close()
        if errors:
            for err in errors:
                st.error(err)
        else:
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–æ–ª–µ–π –ø–æ –Ω–æ–≤—ã–º –ø—Ä–∞–≤–∏–ª–∞–º
            id_plavka = generate_id_plavka(–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞, –ù–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏)
            uchet_number = generate_uchet_number(–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞, –ù–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏)
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ DD.MM.YYYY
            formatted_date = –ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞.strftime('%d.%m.%Y')
            
            new_row = {
                'id_plavka': id_plavka,
                '–£—á–µ—Ç–Ω—ã–π_–Ω–æ–º–µ—Ä': uchet_number,
                '–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞': formatted_date,
                '–ù–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏': –ù–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏,
                '–ù–æ–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä–∞': –ù–æ–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä–∞,
                '–°—Ç–∞—Ä—à–∏–π_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏': –°—Ç–∞—Ä—à–∏–π_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏,
                '–ü–µ—Ä–≤—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏': –ü–µ—Ä–≤—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏,
                '–í—Ç–æ—Ä–æ–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏': –í—Ç–æ—Ä–æ–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏,
                '–¢—Ä–µ—Ç–∏–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏': –¢—Ä–µ—Ç–∏–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏,
                '–ß–µ—Ç–≤–µ—Ä—Ç—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏': –ß–µ—Ç–≤–µ—Ä—Ç—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏,
                '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏': –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏,
                '–¢–∏–ø_—ç–∫—Å–ø–µ—Ä–µ–º–µ–Ω—Ç–∞': –¢–∏–ø_—ç–∫—Å–ø–µ—Ä–µ–º–µ–Ω—Ç–∞,
                '–°–µ–∫—Ç–æ—Ä_A_–æ–ø–æ–∫–∏': –°–µ–∫—Ç–æ—Ä_A_–æ–ø–æ–∫–∏,
                '–°–µ–∫—Ç–æ—Ä_B_–æ–ø–æ–∫–∏': –°–µ–∫—Ç–æ—Ä_B_–æ–ø–æ–∫–∏,
                '–°–µ–∫—Ç–æ—Ä_C_–æ–ø–æ–∫–∏': –°–µ–∫—Ç–æ—Ä_C_–æ–ø–æ–∫–∏,
                '–°–µ–∫—Ç–æ—Ä_D_–æ–ø–æ–∫–∏': –°–µ–∫—Ç–æ—Ä_D_–æ–ø–æ–∫–∏,
                '–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_A': int(–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_A),
                '–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_B': int(–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_B),
                '–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_C': int(–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_C),
                '–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_D': int(–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_D),
                '–ü–ª–∞–≤–∫–∞_–≤—Ä–µ–º—è_–∑–∞–ª–∏–≤–∫–∏': –ü–ª–∞–≤–∫–∞_–≤—Ä–µ–º—è_–∑–∞–ª–∏–≤–∫–∏,
                '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            }
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ SQLite
            conn = sqlite3.connect(DB_FILE)
            columns = ','.join(new_row.keys())
            placeholders = ','.join(['?'] * len(new_row))
            sql = f"INSERT INTO {TABLE_NAME} ({columns}) VALUES ({placeholders})"
            cursor = conn.cursor()
            cursor.execute(sql, list(new_row.values()))
            
            # –ü–æ–ª—É—á–∞–µ–º ID –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏
            last_row_id = cursor.lastrowid
            
            conn.commit()
            conn.close()
            
            # –î–æ–±–∞–≤–ª—è–µ–º ID –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è Excel
            new_row['id'] = last_row_id
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Excel
            add_to_excel(new_row)
            
            # –û—á–∏—â–∞–µ–º –∫—ç—à –¥–∞–Ω–Ω—ã—Ö –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            st.cache_data.clear()
            st.success("–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!")
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏
            if st.button("–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏"):
                menu = "–¢–∞–±–ª–∏—Ü–∞"
                st.rerun()

elif menu == "–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel":
    st.subheader("–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ Excel")
    excel_data = save_to_excel(df)
    st.download_button(
        label="–°–∫–∞—á–∞—Ç—å Excel-—Ñ–∞–π–ª",
        data=excel_data,
        file_name="plavka_export.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )

elif menu == "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞":
    st.subheader("–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∂—É—Ä–Ω–∞–ª–∞")
    if df.empty:
        st.info("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
    else:
        tab1, tab2, tab3, tab4 = st.tabs([
            "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –ø–æ —Å–µ–∫—Ç–æ—Ä–∞–º",
            "–ü–ª–∞–≤–∫–∏ –ø–æ –¥–∞—Ç–∞–º",
            "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –æ—Ç–ª–∏–≤–æ–∫",
            "–£—á–∞—Å—Ç–Ω–∏–∫–∏"
        ])
        with tab1:
            st.markdown("**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä –∑–∞–ª–∏–≤–∫–∏ –ø–æ —Å–µ–∫—Ç–æ—Ä–∞–º**")
            for sector in ['A', 'B', 'C', 'D']:
                col = f'–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_{sector}'
                if col in df.columns:
                    fig = px.histogram(df, x=col, nbins=20, title=f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞–ª–∏–≤–∫–∏ —Å–µ–∫—Ç–æ—Ä {sector}")
                    st.plotly_chart(fig, use_container_width=True)
        with tab2:
            st.markdown("**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞–≤–æ–∫ –ø–æ –¥–∞—Ç–∞–º**")
            if '–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞' in df.columns:
                df['–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞'] = pd.to_datetime(df['–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞'], errors='coerce')
                date_counts = df['–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞'].value_counts().sort_index()
                fig = px.bar(x=date_counts.index, y=date_counts.values, labels={'x': '–î–∞—Ç–∞', 'y': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞–≤–æ–∫'}, title="–ü–ª–∞–≤–∫–∏ –ø–æ –¥–∞—Ç–∞–º")
                st.plotly_chart(fig, use_container_width=True)
        with tab3:
            st.markdown("**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è–º –æ—Ç–ª–∏–≤–æ–∫**")
            if '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏' in df.columns:
                name_counts = df['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏'].value_counts()
                fig = px.pie(values=name_counts.values, names=name_counts.index, title="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –æ—Ç–ª–∏–≤–æ–∫")
                st.plotly_chart(fig, use_container_width=True)
        with tab4:
            st.markdown("**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º**")
            participants = []
            for col in ['–°—Ç–∞—Ä—à–∏–π_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', '–ü–µ—Ä–≤—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', '–í—Ç–æ—Ä–æ–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', '–¢—Ä–µ—Ç–∏–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', '–ß–µ—Ç–≤–µ—Ä—Ç—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏']:
                if col in df.columns:
                    participants.extend(df[col].dropna().astype(str).tolist())
            part_series = pd.Series(participants)
            part_counts = part_series.value_counts()
            fig = px.bar(x=part_counts.index, y=part_counts.values, labels={'x': '–£—á–∞—Å—Ç–Ω–∏–∫', 'y': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–∏–π'}, title="–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≤–æ –≤—Å–µ—Ö –ø–ª–∞–≤–∫–∞—Ö")
            st.plotly_chart(fig, use_container_width=True)

elif menu == "–ò–º–ø–æ—Ä—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è":
    st.subheader("–ò–º–ø–æ—Ä—Ç –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è")
    msg = st.text_area("–í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–æ —Å–º–µ–Ω–µ:", height=400)
    
    # –î–æ–±–∞–≤–∏–º —á–µ–∫–±–æ–∫—Å –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    allow_duplicates = st.checkbox("–†–∞–∑—Ä–µ—à–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —É—á—ë—Ç–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º", value=False)
    
    if st.button("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å"):
        parsed = parse_import_message(msg)
        added, errors, duplicates = 0, 0, 0
        
        # –°–æ–±–∏—Ä–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—á–µ—Ç–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        conn = sqlite3.connect(DB_FILE)
        existing_records = set()
        try:
            cursor = conn.cursor()
            cursor.execute(f"SELECT –£—á–µ—Ç–Ω—ã–π_–Ω–æ–º–µ—Ä FROM {TABLE_NAME}")
            for row in cursor.fetchall():
                if row[0]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–æ–º–µ—Ä –Ω–µ –ø—É—Å—Ç–æ–π
                    existing_records.add(row[0])
            conn.close()
        except Exception as e:
            st.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π: {str(e)}")
            conn.close()
        
        for rec in parsed:
            try:
                # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –∏–∑ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY)
                plavka_date = rec.get('–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞', '')
                
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–æ–ª–µ–π
                uchet = rec.get('–£—á–µ—Ç–Ω—ã–π_–Ω–æ–º–µ—Ä', '')
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
                if uchet and uchet in existing_records and not allow_duplicates and uchet:
                    st.warning(f"–ü—Ä–æ–ø—É—â–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç: –∑–∞–ø–∏—Å—å —Å —É—á—ë—Ç–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º {uchet} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.")
                    duplicates += 1
                    continue
                
                # –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç —É—á–µ—Ç–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ –Ω–µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è id_plavka
                if re.match(r'[0-9]{2}-[0-9]{3}/[0-9]{2}', uchet):
                    mm, nnn_yy = uchet.split('-')
                    nnn, yy = nnn_yy.split('/') # nnn –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã
                    year = int('20' + yy)
                    month = int(mm)
                    id_plavka = f"{year}{month:02d}{nnn}"
                    –Ω–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏ = f"{month}-{nnn}"
                else:
                    # –ï—Å–ª–∏ —É—á–µ—Ç–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–∑ –¥–∞—Ç—ã
                    if plavka_date and re.match(r'[0-9]{2}\.[0-9]{2}\.[0-9]{4}', plavka_date):
                        day, month, year = map(int, plavka_date.split('.'))
                        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –Ω–æ–º–µ—Ä –ø–ª–∞–≤–∫–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                        nnn = "000"  # –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä
                        id_plavka = f"{year}{month:02d}{nnn}"
                        –Ω–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏ = f"{month}-{nnn}"
                    else:
                        id_plavka = ""
                        –Ω–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏ = ""
                
                new_row = {
                    'id_plavka': id_plavka,
                    '–£—á–µ—Ç–Ω—ã–π_–Ω–æ–º–µ—Ä': uchet,
                    '–ü–ª–∞–≤–∫–∞_–¥–∞—Ç–∞': plavka_date,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY
                    '–ù–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏': –Ω–æ–º–µ—Ä_–ø–ª–∞–≤–∫–∏,
                    '–ù–æ–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä–∞': rec.get('–ù–æ–º–µ—Ä_–∫–ª–∞—Å—Ç–µ—Ä–∞', ''),
                    '–°—Ç–∞—Ä—à–∏–π_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏': rec.get('–°—Ç–∞—Ä—à–∏–π_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', ''),
                    '–ü–µ—Ä–≤—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏': rec.get('–ü–µ—Ä–≤—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', ''),
                    '–í—Ç–æ—Ä–æ–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏': rec.get('–í—Ç–æ—Ä–æ–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', ''),
                    '–¢—Ä–µ—Ç–∏–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏': rec.get('–¢—Ä–µ—Ç–∏–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', ''),
                    '–ß–µ—Ç–≤–µ—Ä—Ç—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏': rec.get('–ß–µ—Ç–≤–µ—Ä—Ç—ã–π_—É—á–∞—Å—Ç–Ω–∏–∫_—Å–º–µ–Ω—ã_–ø–ª–∞–≤–∫–∏', ''),
                    '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏': rec.get('–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–æ—Ç–ª–∏–≤–∫–∏', ''),
                    '–¢–∏–ø_—ç–∫—Å–ø–µ—Ä–µ–º–µ–Ω—Ç–∞': rec.get('–¢–∏–ø_—ç–∫—Å–ø–µ—Ä–µ–º–µ–Ω—Ç–∞', ''),
                    '–°–µ–∫—Ç–æ—Ä_A_–æ–ø–æ–∫–∏': rec.get('–°–µ–∫—Ç–æ—Ä_A_–æ–ø–æ–∫–∏', ''),
                    '–°–µ–∫—Ç–æ—Ä_B_–æ–ø–æ–∫–∏': rec.get('–°–µ–∫—Ç–æ—Ä_B_–æ–ø–æ–∫–∏', ''),
                    '–°–µ–∫—Ç–æ—Ä_C_–æ–ø–æ–∫–∏': rec.get('–°–µ–∫—Ç–æ—Ä_C_–æ–ø–æ–∫–∏', ''),
                    '–°–µ–∫—Ç–æ—Ä_D_–æ–ø–æ–∫–∏': rec.get('–°–µ–∫—Ç–æ—Ä_D_–æ–ø–æ–∫–∏', ''),
                    '–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_A': rec.get('–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_A', None),
                    '–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_B': rec.get('–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_B', None),
                    '–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_C': rec.get('–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_C', None),
                    '–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_D': rec.get('–ü–ª–∞–≤–∫–∞_—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞_–∑–∞–ª–∏–≤–∫–∏_D', None),
                    '–ü–ª–∞–≤–∫–∞_–≤—Ä–µ–º—è_–∑–∞–ª–∏–≤–∫–∏': rec.get('–ü–ª–∞–≤–∫–∞_–≤—Ä–µ–º—è_–∑–∞–ª–∏–≤–∫–∏', ''),
                    '–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è_–∫–∞—Ä—Ç–∞': rec.get('–ú–∞—Ä—à—Ä—É—Ç–Ω–∞—è_–∫–∞—Ä—Ç–∞', ''),
                    '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π': rec.get('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π', ''),
                }
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ SQLite
                conn = sqlite3.connect(DB_FILE)
                columns = ','.join(new_row.keys())
                placeholders = ','.join(['?'] * len(new_row))
                sql = f"INSERT INTO {TABLE_NAME} ({columns}) VALUES ({placeholders})"
                cursor = conn.cursor()
                cursor.execute(sql, list(new_row.values()))
                
                # –ü–æ–ª—É—á–∞–µ–º ID –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏
                last_row_id = cursor.lastrowid
                
                conn.commit()
                conn.close()
                
                # –î–æ–±–∞–≤–ª—è–µ–º ID –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è Excel
                new_row['id'] = last_row_id
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Excel
                add_to_excel(new_row)
                
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —É—á–µ—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –≤ —Å–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö
                if uchet:
                    existing_records.add(uchet)
                    
                added += 1
            except Exception as e:
                errors += 1
                st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ —Å –£—á–µ—Ç–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º {uchet}: {e}")
        
        st.success(f"–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: {added}. –î—É–±–ª–∏–∫–∞—Ç–æ–≤: {duplicates}. –û—à–∏–±–æ–∫: {errors}.")
        
        # –û—á–∏—â–∞–µ–º –∫—ç—à –¥–∞–Ω–Ω—ã—Ö
        st.cache_data.clear()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
        if added > 0 and st.button("–ü–æ–∫–∞–∑–∞—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏"):
            menu = "–¢–∞–±–ª–∏—Ü–∞"
            st.rerun()

elif menu == "–û –ø—Ä–æ–≥—Ä–∞–º–º–µ":
    st.markdown("""
    ### –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª –ø–ª–∞–≤–∫–∏
    - –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Streamlit
    - –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ SQLite –∏ Excel
    - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏: –ø—Ä–æ—Å–º–æ—Ç—Ä, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, —ç–∫—Å–ø–æ—Ä—Ç, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
    
    **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏:**
    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ Excel –∏ SQLite
    - –£–ª—É—á—à–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
    - –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    """) 