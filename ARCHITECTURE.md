# Архитектура электронного журнала плавки

## Обзор проекта

Электронный журнал плавки - это комплексная система для сбора, хранения и анализа данных о металлургических плавках. Система состоит из нескольких взаимосвязанных компонентов, обеспечивающих удобный ввод данных через различные интерфейсы и централизованное хранение.

## Архитектурная диаграмма

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Desktop App   │    │   Web App       │    │  Telegram Bot   │
│   (PySide6)     │    │   (Streamlit)   │    │   (python-telegram-bot)│
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          │ Ввод данных          │ Ввод/просмотр        │ Импорт сообщений
          ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Хранилище данных                              │
│  ┌─────────────────┐    ┌─────────────────┐                      │
│  │  Excel файл     │◄──►│  SQLite БД      │                      │
│  │  (plavka.xlsx)  │    │  (plavka.db)    │                      │
│  └─────────────────┘    └─────────────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

## Основные компоненты

### 1. Desktop приложение (plavka.py)
- **Технология**: PySide6 (Qt6)
- **Назначение**: Основной интерфейс для ввода данных о плавках
- **Функциональность**:
  - Форма ввода с валидацией данных
  - Автоматическая нумерация записей
  - Сохранение в Excel с бэкапами
  - Логирование операций
- **Особенности**: Полнофункциональный GUI с современным дизайном в стиле Nord

### 2. Web приложение (streamlit_app.py)
- **Технология**: Streamlit + Plotly
- **Назначение**: Просмотр, фильтрация и анализ данных
- **Функциональность**:
  - Отображение данных из SQLite
  - Фильтрация по различным параметрам
  - Добавление новых записей
  - Экспорт в Excel
  - Визуализация данных (графики, диаграммы)
  - Импорт данных из текстовых сообщений

### 3. Telegram бот (telegram_bot.py, telegram_import.py)
- **Технология**: python-telegram-bot
- **Назначение**: Автоматический импорт данных из Telegram
- **Функциональность**:
  - Парсинг структурированных сообщений
  - Извлечение данных о плавках
  - Автоматическое сохранение в Excel
  - Обработка ошибок и логирование

### 4. Модуль миграции (migrate_excel_to_sqlite.py)
- **Назначение**: Синхронизация данных между Excel и SQLite
- **Функциональность**:
  - Чтение данных из Excel
  - Преобразование типов данных
  - Загрузка в SQLite базу данных

## Хранилище данных

### Excel файл (plavka.xlsx)
- **Назначение**: Основное хранилище и бэкап
- **Структура**: Таблица с 37 полями данных о плавках
- **Особенности**: 
  - Автоматическое создание бэкапов
  - Обработка ошибок доступа к файлу
  - Валидация данных при записи

### SQLite база данных (plavka.db)
- **Назначение**: Оптимизированное хранилище для web-приложения
- **Структура**: Таблица "Плавки" с индексированными полями
- **Особенности**:
  - Быстрый доступ для чтения
  - Поддержка сложных запросов и фильтрации
  - Синхронизация с Excel через модуль миграции

## Потоки данных

### Основной сценарий (Happy Path)
1. **Ввод данных через Desktop приложение**:
   - Пользователь заполняет форму в desktop приложении
   - Данные валидируются (температура, время, форматы)
   - Запись сохраняется в Excel файл
   - Создается бэкап файла
   - Операция логируется

2. **Просмотр и анализ через Web приложение**:
   - Пользователь открывает web интерфейс
   - Данные загружаются из SQLite базы
   - Возможна фильтрация и сортировка
   - Построение графиков и диаграмм
   - Экспорт отфильтрованных данных

3. **Импорт через Telegram**:
   - Пользователь отправляет структурированное сообщение
   - Бот парсит сообщение и извлекает данные
   - Данные сохраняются в Excel файл
   - Процесс логируется

### Дополнительные сценарии
- **Миграция данных**: Excel → SQLite для синхронизации
- **Сборка EXE**: Создание дистрибутива для Windows
- **Запуск через BAT**: Упрощенный запуск для конечных пользователей

## Слой абстракции данных

### Уровень данных
- **Excel operations**: Чтение/запись Excel файлов через openpyxl
- **SQLite operations**: Работа с базой данных через sqlite3
- **Data validation**: Валидация данных перед сохранением

### Уровень бизнес-логики
- **Form processing**: Обработка форм ввода
- **Data parsing**: Парсинг текстовых сообщений
- **Business rules**: Правила валидации и бизнес-ограничения

### Уровень представления
- **Desktop GUI**: PySide6 интерфейс
- **Web UI**: Streamlit интерфейс
- **Bot interface**: Telegram бот

## Конфигурация и окружение

### Переменные окружения
- `BOT_TOKEN`: Токен Telegram бота (требуется для работы бота)
- `PYTHONPATH`: Пути к модулям Python

### Файлы конфигурации
- `requirements.txt`: Зависимости Python
- `db_schema.sql`: Схема SQLite базы данных
- `plavka_app.spec`: Конфигурация PyInstaller

### Пути к файлам
- `plavka.xlsx`: Основной файл данных
- `plavka.db`: SQLite база данных
- `plavka.log`: Файл логирования

## Безопасность

### Риски
- **Пароль токена бота**: Хранится в коде (рекомендуется вынести в переменные окружения)
- **Доступ к файлам**: Excel файл может быть заблокирован другой программой
- **Валидация данных**: Ограниченная валидация входных данных

### Меры безопасности
- Логирование всех операций
- Создание бэкапов перед изменениями
- Обработка ошибок доступа к файлам

## Масштабирование и производительность

### Текущие ограничения
- **Файловое хранилище**: Excel файл не подходит для больших объемов данных
- **Отсутствие индексов**: В SQLite отсутствуют оптимизированные индексы
- **Блокировка файла**: Только один процесс может записывать в Excel

### Потенциальные улучшения
- Переход на PostgreSQL для больших объемов данных
- Добавление индексов в SQLite
- Реализация API для интеграций
- Кэширование данных в web приложении

## Тестируемость

### Текущее состояние
- **Отсутствие тестов**: В проекте нет unit-тестов или интеграционных тестов
- **Монолитная структура**: Код тесно связан, сложно тестировать отдельные компоненты

### Рекомендации по тестированию
- Выделение бизнес-логики в отдельные модули
- Создание unit-тестов для функций парсинга и валидации
- Интеграционные тесты для операций с базой данных
- UI тесты для критических сценариев

## Развертывание и эксплуатация

### Способы развертывания
1. **Локальный запуск**: Через BAT файлы или напрямую
2. **EXE дистрибутив**: Автономное приложение для Windows
3. **Web развертывание**: Streamlit сервер

### Мониторинг
- Логирование в файл `plavka.log`
- Обработка ошибок с детальной информацией
- Резервное копирование данных

## Зависимости

### Основные зависимости
- `PySide6>=6.6.1`: GUI фреймворк для desktop приложения
- `streamlit`: Web фреймворк для web приложения
- `pandas>=2.1.4`: Обработка данных
- `plotly`: Визуализация данных
- `openpyxl>=3.1.2`: Работа с Excel файлами
- `python-telegram-bot`: Telegram бот API
- `sqlite3`: Работа с SQLite базой данных (встроенный)

### Зависимости для разработки
- `pyinstaller`: Создание EXE файлов
- `xlsxwriter`: Запись Excel файлов

## Рекомендации по улучшению

### Краткосрочные (S - Small)
1. **Вынести BOT_TOKEN в переменные окружения**
2. **Добавить базовые unit-тесты** для функций парсинга
3. **Улучшить валидацию данных** на стороне клиента
4. **Добавить индексы** в SQLite базу данных

### Среднесрочные (M - Medium)
1. **Рефакторинг кода**: Выделение бизнес-логики в отдельные модули
2. **Добавить API**: REST API для интеграций
3. **Улучшить обработку ошибок**: Более детальные сообщения
4. **Добавить конфигурационный файл**: Для настройки параметров

### Долгосрочные (L - Large)
1. **Миграция на PostgreSQL**: Для лучшей производительности
2. **Реализация микросервисной архитектуры**: Разделение на независимые сервисы
3. **Добавить систему аутентификации**: Для web приложения
4. **Реализация системы бэкапов**: Автоматическое резервное копирование

## Заключение

Текущая архитектура обеспечивает функциональность для сбора и анализа данных о плавках, но имеет ограничения по масштабируемости и тестируемости. Рекомендуется постепенная модернизация с фокусом на разделение ответственности, добавление тестов и улучшение безопасности.