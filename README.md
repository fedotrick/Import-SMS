# Telegram-бот для ведения журнала plavka.xlsx

Телеграм-бот принимает текстовые сообщения от оперативного персонала и добавляет их в таблицу `plavka.xlsx`. Файл используется как единый источник данных и хранится в каталоге `./Контроль`. Бот предоставляет удобное инлайн-меню, просмотр последних записей и возможность скачать актуальный файл журнала.

## Возможности

- Инлайн-меню с командами: «Добавить запись», «Последние записи», «Скачать plavka.xlsx», «Справка».
- Безопасная запись сообщений в Excel с блокировкой файла и проверкой структуры листа.
- Просмотр последних 10 записей журнала прямо в чате.
- Отправка файла `plavka.xlsx` пользователю.
- Готовность к развёртыванию в Docker с сохранением данных на хосте.

## Структура Excel-файла

Бот управляет единственным листом книги. Заголовок и порядок столбцов строго фиксированы:

| № | Столбец      | Описание                                   |
|---|--------------|---------------------------------------------|
| 1 | `timestamp`  | Дата и время добавления записи (ISO 8601). |
| 2 | `user_id`    | Telegram user_id автора сообщения.        |
| 3 | `username`   | username или отображаемое имя пользователя.|
| 4 | `chat_id`    | Идентификатор чата, откуда пришло сообщение.|
| 5 | `message_id` | Идентификатор сообщения в Telegram.        |
| 6 | `text`       | Текст сообщения.                           |

Если файл отсутствует или пуст, бот создаст его автоматически и пропишет заголовки.

## Локальный запуск

1. Установите Python 3.10 или новее.
2. Создайте виртуальное окружение и установите зависимости:

   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   pip install -r requirements.txt
   ```

3. Скопируйте файл настроек и заполните токен бота:

   ```bash
   cp .env.example .env
   ```

   Обязательные переменные окружения описаны в разделе [Переменные окружения](#переменные-окружения).

4. Убедитесь, что каталог `Контроль` существует. При первом запуске бот создаст `plavka.xlsx` автоматически.
5. Запустите бота:

   ```bash
   python main.py
   ```

## Запуск в Docker

1. Скопируйте `.env.example` в `.env` и укажите реальное значение `BOT_TOKEN`.
2. Убедитесь, что каталог `Контроль` существует рядом с `docker-compose.yml`. При необходимости создайте его:

   ```bash
   mkdir -p Контроль
   ```

3. Запустите контейнеры:

   ```bash
   docker-compose up --build
   ```

   - Бот будет работать в контейнере `bot`.
   - Файл `Контроль/plavka.xlsx` монтируется в контейнер и сохраняется на хосте.
   - При необходимости остановите бота командой `docker-compose down`.

4. Healthcheck контейнера отслеживает статус фонового процесса бота.

## Переменные окружения

| Имя        | Значение по умолчанию        | Описание                                                                 |
|------------|------------------------------|--------------------------------------------------------------------------|
| `BOT_TOKEN`| —                            | Токен Telegram-бота от BotFather (обязательно).                          |
| `XLSX_PATH`| `./Контроль/plavka.xlsx`     | Путь к файлу Excel. Не меняйте относительный путь без необходимости.    |
| `LOCALE`   | `ru`                         | Локаль для форматирования даты и времени. При отсутствии локали будет предупреждение в логах.

## Структура проекта

```
.
├── Контроль/
│   └── plavka.xlsx          # Файл журнала
├── main.py                  # Точка входа бота
├── requirements.txt         # Список зависимостей
├── docker-compose.yml       # Запуск в Docker
├── Dockerfile               # Образ с ботом
├── src/
│   ├── bot/
│   │   ├── handlers/        # Хэндлеры команд и состояний
│   │   ├── keyboards/       # Инлайн-клавиатуры
│   │   └── services/        # Работа с Excel
│   └── core/
│       └── config.py        # Загрузка настроек
└── .env.example             # Шаблон переменных окружения
```

## Логи и обработка ошибок

Логи пишутся в стандартный вывод в структурированном формате JSON и содержат ключевые действия (добавление записей, ошибки чтения/записи файла). Пользователю отправляются понятные сообщения в случае ошибок валидации или проблем с доступом к файлу.

## Разработка

- Следуйте PEP 8 и принятой структурности проекта.
- Для генерации быстрой тестовой записи используйте пункт меню «Добавить запись».
- В репозитории важно хранить только необходимые файлы бота и таблицу журнала.
